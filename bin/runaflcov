#!/bin/bash

# Called with BIN set to the binary with clang cov instrumentation.
# https://clang.llvm.org/docs/SourceBasedCodeCoverage.html

set -euo pipefail
#IFS=

_which() {
    which "$1" > /dev/null 2>&1
}

for p in llvm-profdata-11 llvm-profdata; do
    if _which $p; then
        llvm_profdata=$p
        break
    fi
done

for p in llvm-cov-11 llvm-cov; do
    if _which $p; then
        llvm_cov=$p
        break
    fi
done

PAGER=${PAGER-less}


profile_file_base=$BIN.profraw

rm -rf "$profile_file_base"

(
    i=0
    # aflfind/crashes/id\:* can't be used as the crashes inhibit the
    # recording of the coverage information, d'oh.  But then, the
    # purpose of runaflcov is to find places that need to be helped,
    # when not finding crashes. I.e. just fix your crashes before
    # using / continuing to use runaflcov!
    for f in aflfind/queue/* ; do
        if [ -e "$f" ]; then
            echo "== $f ==";
            export LLVM_PROFILE_FILE=$profile_file_base/$i
            i=$(( i + 1 ))
            set +e
            "$BIN" "$f"
            echo $?
            set -e
            echo
        fi
    done
) 2>&1|less

"$llvm_profdata" merge -sparse "$profile_file_base"/* -o "$BIN".profdata

# line-oriented coverage report
if [ "${SHOW_EXPANSIONS-0}" = 1 ]; then
    llvm_cov_flags=--show-expansions
else
    llvm_cov_flags=
fi

"$llvm_cov" show "$BIN" -instr-profile="$BIN".profdata $llvm_cov_flags -use-color | $PAGER

# TODO:

# --show-branches with newer llvm-cov ?

# The llvm-cov tool supports specifying a custom demangler, writing out reports in a directory structure, and generating html reports. For the full list of options, please refer to the command guide.

